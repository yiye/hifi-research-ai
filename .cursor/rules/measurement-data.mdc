---
description: 音频测量数据处理和分析规范
globs:
  - "**/*measurement*.{ts,js,py}"
  - "**/*test*.{ts,js,py}"
  - "**/*analysis*.{ts,js,py}"
alwaysApply: false
---

# 音频测量数据处理规则

## 测量标准与协议

### 遵循的国际标准
- **IEC 61606-3**: 音频设备测量方法
- **AES17**: 数字音频设备测量标准
- **IEC 60268**: 音响系统设备标准
- **ITU-R BS.1116**: 主观评价方法

### 测试信号

#### 标准测试频率
```typescript
const TEST_FREQUENCIES = [
  20, 30, 40, 50, 60, 70, 80, 90, 100,    // 低频
  200, 300, 400, 500, 600, 700, 800, 900, 1000,  // 中低频
  2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000,  // 中高频
  12000, 14000, 16000, 18000, 20000       // 高频
];

const KEY_TEST_FREQUENCIES = [20, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000];
```

#### 测试信号类型
- **正弦波（Sine Wave）**: 用于 THD、频响测试
- **方波（Square Wave）**: 用于瞬态响应
- **脉冲（Impulse）**: 用于时域分析
- **白噪声（White Noise）**: 用于频谱分析
- **粉噪声（Pink Noise）**: 用于主观评价
- **扫频信号（Chirp/Sweep）**: 用于频响曲线
- **多音信号（Multitone）**: 用于 IMD 测试

### THD+N 测量规范

```python
def measure_thd_n(
    frequency: int = 1000,      # Hz
    amplitude: float = -1.0,     # dBFS
    load: int = 32,              # Ω
    duration: float = 1.0,       # seconds
    sample_rate: int = 192000    # Hz
) -> dict:
    """
    测量总谐波失真加噪声
    
    标准测量条件：
    - 频率：1kHz（标准）或 40Hz-15kHz（扫频）
    - 电平：-1dBFS 或 -3dBFS
    - 负载：32Ω（耳机）或 8Ω（音箱）
    - 测量带宽：20Hz-20kHz 或 20Hz-80kHz
    """
    return {
        'thd_n_percent': 0.0,
        'thd_percent': 0.0,
        'noise_floor': 0.0,  # dBFS
        'fundamental': 0.0,   # dBFS
        'harmonics': [],      # 各次谐波的dB值
        'condition': {
            'frequency': frequency,
            'amplitude': amplitude,
            'load': load,
            'sample_rate': sample_rate,
            'bandwidth': (20, 20000)
        }
    }
```

### 频率响应测量

```python
def measure_frequency_response(
    start_freq: int = 20,
    end_freq: int = 20000,
    points: int = 100,
    amplitude: float = -1.0,  # dBFS
    method: str = 'sweep'     # 'sweep' or 'stepped'
) -> dict:
    """
    测量频率响应
    
    返回格式：
    - frequencies: 频率点数组（Hz）
    - magnitudes: 幅度数组（dB）
    - phases: 相位数组（degree）
    """
    return {
        'frequencies': [],
        'magnitudes': [],  # dB relative to 1kHz
        'phases': [],
        'flatness': 0.0,   # dB (20Hz-20kHz)
        'reference_freq': 1000  # Hz
    }
```

### SNR / DNR 测量

```python
def measure_snr(
    signal_level: float = -1.0,   # dBFS
    measurement_bandwidth: tuple = (20, 20000),  # Hz
    weighting: str = 'A'          # 'A', 'C', or 'Z' (unweighted)
) -> dict:
    """
    测量信噪比
    
    - A-weighting: 模拟人耳感知
    - C-weighting: 较少衰减低频
    - Z-weighting (unweighted): 无加权
    """
    return {
        'snr_db': 0.0,
        'noise_floor_db': 0.0,
        'signal_level_db': signal_level,
        'weighting': weighting,
        'bandwidth': measurement_bandwidth
    }
```

### IMD 测量（互调失真）

```python
def measure_imd(
    method: str = 'CCIF',  # 'CCIF' or 'SMPTE'
    amplitude: float = -1.0
) -> dict:
    """
    互调失真测量
    
    CCIF (ITU-R): 19kHz + 20kHz，测量 1kHz 差频
    SMPTE: 60Hz + 7kHz (4:1 ratio)
    """
    if method == 'CCIF':
        test_freqs = (19000, 20000)
        diff_freq = 1000
    elif method == 'SMPTE':
        test_freqs = (60, 7000)
        diff_freq = None
    
    return {
        'imd_percent': 0.0,
        'method': method,
        'test_frequencies': test_freqs,
        'amplitude': amplitude
    }
```

## 数据采集规范

### 采样与量化
```typescript
interface AcquisitionSettings {
  sampleRate: number;      // ≥192kHz for Hi-Fi testing
  bitDepth: 24 | 32;       // 至少 24-bit
  channelCount: 1 | 2;
  duration: number;         // seconds
  bufferSize: number;       // samples
  inputRange: number;       // Vpp or dBFS
}
```

### 测试环境记录
```typescript
interface TestEnvironment {
  temperature: number;      // °C
  humidity: number;         // %
  ambientNoise: number;     // dBA
  equipment: {
    analyzer: string;       // "Audio Precision APx555" etc.
    loadBox?: string;
    powerSupply?: string;
  };
  calibration: {
    date: string;
    reference: string;
  };
}
```

## 数据处理

### 滤波要求
- **抗混叠滤波**: 测量前应用
- **加权滤波**: A-weighting for SNR
- **带通滤波**: 限制测量带宽
- **陷波滤波**: 去除特定频率干扰

### 平均处理
```python
# 多次测量取平均（降低随机误差）
MEASUREMENT_REPETITIONS = 3  # 最少 3 次
OUTLIER_THRESHOLD = 2.0      # 标准差倍数

def average_measurements(measurements: list) -> dict:
    """
    对多次测量取平均，剔除异常值
    返回平均值、标准差和置信区间
    """
    pass
```

### 数值精度
- THD/IMD: 保留 4 位小数 (0.0001%)
- SNR/DNR: 保留 1 位小数 (0.1 dB)
- 频响: 保留 2 位小数 (0.01 dB)
- 相位: 保留 1 位小数 (0.1°)

## 数据可视化

### 频响曲线
```python
import matplotlib.pyplot as plt

def plot_frequency_response(freq, mag, phase=None):
    """
    绘制频响曲线
    - X 轴：对数刻度，20Hz-20kHz
    - Y 轴：dB，通常 ±3dB 或 ±10dB
    - 网格：主网格 + 次网格
    """
    fig, ax = plt.subplots()
    ax.semilogx(freq, mag)
    ax.set_xlabel('Frequency (Hz)')
    ax.set_ylabel('Magnitude (dB)')
    ax.set_xlim(20, 20000)
    ax.grid(True, which='both', alpha=0.3)
    # ISO 标准频率刻度
    ax.set_xticks([20, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000])
```

### THD vs 频率/功率
```python
def plot_thd_vs_frequency(freq, thd):
    """X轴：对数刻度频率；Y轴：对数刻度 THD%"""
    pass

def plot_thd_vs_power(power, thd, load):
    """X轴：输出功率（dBW 或 mW）；Y轴：THD%"""
    pass
```

## 测量报告格式

```markdown
# 设备测量报告

## 测试设备
- 被测设备：[品牌 型号]
- 测试仪器：[Audio Precision APx555]
- 测试日期：[YYYY-MM-DD]

## 测试条件
- 电源电压：[V]
- 负载阻抗：[Ω]
- 环境温度：[°C]
- 预热时间：[分钟]

## 测量结果

### THD+N @ 1kHz
| 输出电平 | 负载 | THD+N | 备注 |
|---------|------|-------|------|
| -1dBFS  | 32Ω  | 0.0005% | |

### 频率响应
- 20Hz-20kHz: ±0.1dB
- 附图：[frequency_response.png]

### 信噪比
- A-weighted: 120dB
- Unweighted: 118dB

[...]
```

## 注意事项

1. **热机**: 设备应预热至少 30 分钟
2. **负载匹配**: 使用标准精密电阻作为负载
3. **接地**: 注意接地回路，避免引入工频干扰
4. **电源**: 使用纯净电源，必要时使用线性电源
5. **校准**: 定期校准测试设备
6. **重复性**: 关键测量应多次验证
